---
layout: post
title:  "reviewrepublic - 비용최적화 & 마이그레이션 프로젝트 일지 (1)"
date:   2018-09-11
categories: reviewrepublic migragtion
---

리뷰리퍼블릭이라는 조그만 커뮤니티가 있다. 페이스북에 리뷰왕 김리뷰라는 페이지가 있다. 갖가지 리뷰들이 올라오고 요새 올라오는 카드뉴스식의 리뷰를 이끌어간 페이지이다. 어쨋든 그런 조그마한 커뮤니티 앱이 월 100만원 가량의 유지비가 나온다는 소식을 들었다. 아무리 생각해도 오버스펙이다. 리뷰리퍼블릭이라는 사이트의 처음 취지를 들었다. 리뷰리퍼블릭은 리뷰 등을 작성하는 사람에게 적절한 보상을 주기 위해 만든 서비스이다. 그런데 서비스 유지비용이 월 100만원씩 나온다면 도저히 수지타산이 안나온다. 그리고 월 100만원이라는 비용은 아무리 생각해도 리소스를 낭비하는 것 같다. 

그래서 비용을 줄이는 데에 도움이 되고 싶었다. 마침 클라우드 서비스를 공부하고 있기도 했고 공부하다가 실질적인 서비스를 운용해봐야 좀 더 실질적인 공부가 될 것 같기도 해서 덜컥 김리뷰계정에 메세지를 보냈다. "아무리 봐도 100만원은 오바다. 회사가 망하기도 했고 여러가지로 힘든상황인것 같지만 리뷰리퍼블릭의 취지 자체는 좋은것 같다. 나에게도 한 사이트의 비용구조 개선은 공부가 된다. 도와주겠다." 라고 연락을 했다. 그러나 첫번째에는 답이 없었다. 

다시 연락을 했다. 똑같은 내용으로. 답변이 왔다. 연락이 왔던걸 못봤다. 도와주시기만 하면 너무 고맙다. 그래서 김리뷰씨를 직접 대면했다. 대면하고 보니 전의 개발자가 풀스택이라고 개발을 해놓고 리소스 관리에 대한 고민은 별로 없었던 것 같다. 그러다 보니 서버 유지비가 100만원이 나왔다. 여차저차 낭비하는 부분이 눈에 보였고 그것만 개선하면 충분히 비용을 줄이면서 퍼포먼스까지 개선할 수 있을 것 같았다. 거기에 그저 서버만 이전하면 될것 같아서 공수도 많이 안들 것 같았다. 그래서 흔쾌히 작업을 시작했다. 

착각이었다. 생각보다 복잡한 구조를 가진 어플리케이션이었고 많이 쓰이지 않는 프레임워크(meteor.js)로 제작되어있었다. 해당 프레임워크를 공부해야했고, 리소스를 낭비해야할 만하게 어플리케이션이 구성되어 있었다. 그러니깐 인프라 구성만 바꾼다고 되는게 아니라 어플리케이션 자체를 수정해야 비용구조를 개선하고 퍼포먼스도 올릴 수 있는 프로젝트였던 것이다. 애초의 생각보다 훨씬 큰 프로젝트였던 것이다. 

그래서 일단 인프라 레벨에서부터 접근했다. 인프라 레벨에서 오버스펙이나 가성비등을 따져서 클라우드 사업자를 비교했다. 아마도 가성비 때문에 digital ocean을 선택한듯 했지만 오히려 그 덕분에 비용이 더 나오고 퍼포먼스는 떨어졌다. 따져보니 스테이징, 디벨롭 서버 등의 구성을 빼고 AWS로 이관하면 월 20정도는 줄이면서 퍼포먼스는 더 잘 나올 것 같았다. 

그리고 서비스의 db를 몽고db를 사용했고 몽고db를 mlab이라는 서비스를 이용해서 구성했는데 mlab이 아무래도 너무 창렬이었다. 차라리 mongodb 자체에서 서비스하는 atlas라는 서비스가 가성비 측면에서, 퍼포먼스 측면에서 월등히 우세했다. 

그래서 최적화 작업을 위해 첫번째 작업으로 
1. Digital Ocean -> AWS
2. Mlab -> Atlas
이 정도로 잡았다. 

이 과정에서 꽤 많은 이슈가 있었다. 그 이슈에 대해서는 다음 포스팅에... 

**리뷰리퍼블릭의 기존 아키텍쳐**
![그림1](/images/reviewrepublic-legacy.png)

**리뷰리퍼블릭 변경 아키텍쳐**
![그림2](/images/reviewrepublic-tobe.png)
